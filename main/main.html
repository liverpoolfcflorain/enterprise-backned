<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Enterprise - Crisis Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
        }

        /* Header */
        .header {
            border-bottom: 1px solid #ca8a04;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            color: #eab308;
            font-weight: bold;
            font-size: 1.25rem;
        }

        /* Hamburger Menu */
        .hamburger-menu {
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background: transparent;
            border: 2px solid #ca8a04;
            border-radius: 4px;
            padding: 8px;
            transition: all 0.3s ease;
        }

        .hamburger-menu:hover {
            background-color: rgba(202, 138, 4, 0.2);
            border-color: #eab308;
        }

        .hamburger-line {
            width: 24px;
            height: 3px;
            background-color: #eab308;
            margin: 2px 0;
            transition: all 0.3s ease;
        }

        .hamburger-menu:hover .hamburger-line {
            background-color: #facc15;
        }

        /* Crisis Section */
        .crisis-section {
            border-bottom: 1px solid #ca8a04;
            padding: 4rem 4rem;
        }

        .crisis-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .crisis-logo {
            flex-shrink: 0;
        }

        .crisis-logo img {
            width: 16rem;
            height: 16rem;
            object-fit: contain;
            margin: 0 auto;
        }

        .crisis-info {
            flex: 1;
            margin-left: 8rem;
            min-width: 300px;
        }

        .crisis-title {
            color: #eab308;
            font-size: 4.5rem;
            font-weight: bold;
            margin-bottom: 2rem;
            letter-spacing: 0.05em;
            text-align: left;
            line-height: 1;
        }

        .crisis-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: flex-start;
        }

        .budget {
            color: #fff;
            font-size: 2.25rem;
            font-weight: bold;
            text-align: left;
            line-height: 1;
        }

        .timer {
            color: #eab308;
            font-size: 3rem;
            font-weight: bold;
            text-align: left;
            line-height: 1;
        }

        .timer.time-up {
            color: #ef4444;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Data Room Section */
        .dataroom-section {
            border-bottom: 1px solid #ca8a04;
            padding: 4rem;
        }

        .dataroom-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .dataroom-header img {
            width: 6rem;
            height: 6rem;
            object-fit: contain;
        }

        .dataroom-title {
            color: #eab308;
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        .dataroom-text {
            width: 100%;
            min-height: 24rem;
            background-color: #111827;
            color: #ca8a04;
            font-size: 1.25rem;
            padding: 1rem;
            border: 2px solid #eab308;
            border-radius: 0.25rem;
        }

        /* Options Section */
        .options-section {
            border-bottom: 1px solid #ca8a04;
            padding: 4rem;
        }

        .options-content {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .options-logo {
            flex-shrink: 0;
            margin: 0 auto;
        }

        .options-logo img {
            width: 16rem;
            height: 16rem;
            object-fit: contain;
        }

        .options-list {
            flex: 1;
            margin-left: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 300px;
        }

        .option-button {
            width: 100%;
            border: 2px solid #ca8a04;
            padding: 1.5rem;
            text-align: left;
            background-color: transparent;
            color: #eab308;
            font-size: 1.25rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .option-button:hover:not(:disabled) {
            background-color: rgba(113, 63, 18, 0.2);
        }

        .option-button.selected {
            background-color: rgba(202, 138, 4, 0.3);
            border-color: #facc15;
        }

        .option-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm-button {
            width: 100%;
            padding: 1.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            border-radius: 0.5rem;
            border: 2px solid #4b5563;
            background-color: #374151;
            color: #6b7280;
            cursor: not-allowed;
            transition: all 0.3s;
        }

        .confirm-button:not(:disabled) {
            background-color: #ca8a04;
            color: #000;
            border-color: #eab308;
            cursor: pointer;
        }

        .confirm-button:not(:disabled):hover {
            background-color: #eab308;
        }

        .confirm-button.confirmed {
            background-color: #15803d;
            color: #fff;
        }

        .confirm-button.error {
            background-color: #b91c1c;
            color: #fff;
            border-color: #dc2626;
        }

        /* Leaderboard Section */
        .leaderboard-section {
            border-bottom: 1px solid #ca8a04;
            padding: 4rem;
        }

        .leaderboard-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .leaderboard-header img {
            width: 6rem;
            height: 6rem;
            object-fit: contain;
        }

        .leaderboard-title {
            color: #eab308;
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #111827;
            border: 2px solid #eab308;
        }

        .leaderboard-table thead {
            background-color: #ca8a04;
            color: #000;
        }

        .leaderboard-table th {
            padding: 1rem;
            text-align: left;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .leaderboard-table td {
            padding: 1rem;
            border-top: 1px solid #ca8a04;
            color: #eab308;
            font-size: 1.125rem;
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: rgba(202, 138, 4, 0.05);
        }

        .rank-1 {
            background-color: rgba(234, 179, 8, 0.2) !important;
        }

        .rank-2 {
            background-color: rgba(156, 163, 175, 0.2) !important;
        }

        .rank-3 {
            background-color: rgba(205, 127, 50, 0.2) !important;
        }

        .rank-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: bold;
            font-size: 1rem;
        }

        .rank-badge.gold {
            background-color: #eab308;
            color: #000;
        }

        .rank-badge.silver {
            background-color: #9ca3af;
            color: #000;
        }

        .rank-badge.bronze {
            background-color: #cd7f32;
            color: #000;
        }

        /* Footer */
        .footer {
            border-top: 1px solid #ca8a04;
            padding: 1rem 2rem;
            text-align: right;
        }

        .footer-text {
            color: #ca8a04;
            font-family: serif;
            font-size: 1.25rem;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .crisis-info {
                margin-left: 0;
            }

            .crisis-title {
                font-size: 3rem;
                text-align: center;
            }

            .crisis-stats {
                align-items: center;
            }

            .budget,
            .timer {
                text-align: center;
            }

            .options-list {
                margin-left: 0;
            }

            .dataroom-header {
                flex-direction: column;
                text-align: center;
            }

            .dataroom-title {
                font-size: 2.5rem;
            }

            .leaderboard-header {
                flex-direction: column;
                text-align: center;
            }

            .leaderboard-title {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 1rem;
            }

            .logo {
                font-size: 1rem;
            }

            .hamburger-menu {
                width: 35px;
                height: 35px;
                padding: 6px;
            }

            .hamburger-line {
                width: 20px;
                height: 2px;
            }

            .crisis-section,
            .dataroom-section,
            .options-section,
            .leaderboard-section {
                padding: 2rem 1rem;
            }

            .crisis-content {
                flex-direction: column;
            }

            .crisis-logo img,
            .options-logo img {
                width: 10rem;
                height: 10rem;
            }

            .crisis-title {
                font-size: 2rem;
                text-align: center;
            }

            .crisis-stats {
                align-items: center;
            }

            .budget {
                font-size: 1.5rem;
                text-align: center;
            }

            .timer {
                font-size: 2rem;
                text-align: center;
            }

            .dataroom-header img {
                width: 4rem;
                height: 4rem;
            }

            .dataroom-title {
                font-size: 1.5rem;
            }

            .dataroom-text {
                font-size: 1rem;
                min-height: 16rem;
                padding: 0.75rem;
            }

            .options-content {
                flex-direction: column;
            }

            .options-list {
                margin-left: 0;
            }

            .option-button {
                font-size: 1rem;
                padding: 1rem;
            }

            .confirm-button {
                font-size: 1rem;
                padding: 1rem;
            }

            .leaderboard-header img {
                width: 4rem;
                height: 4rem;
            }

            .leaderboard-title {
                font-size: 1.5rem;
            }

            .leaderboard-table {
                font-size: 0.875rem;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 0.5rem;
                font-size: 0.875rem;
            }

            .rank-badge {
                font-size: 0.75rem;
                padding: 0.15rem 0.5rem;
            }

            .footer {
                padding: 1rem;
            }

            .footer-text {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .crisis-logo img,
            .options-logo img {
                width: 8rem;
                height: 8rem;
            }

            .crisis-title {
                font-size: 1.75rem;
            }

            .budget {
                font-size: 1.25rem;
            }

            .timer {
                font-size: 1.5rem;
            }

            .dataroom-title,
            .leaderboard-title {
                font-size: 1.25rem;
            }

            .dataroom-text {
                font-size: 0.875rem;
            }

            .option-button,
            .confirm-button {
                font-size: 0.875rem;
                padding: 0.75rem;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 0.4rem;
                font-size: 0.75rem;
            }

            .rank-badge {
                font-size: 0.65rem;
                padding: 0.1rem 0.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">ABC</div>
        <button class="hamburger-menu" onclick="document.location.href='login.html'" aria-label="Menu">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </button>
    </div>

    <!-- Crisis Section -->
    <div class="crisis-section">
        <div class="crisis-content">
            <div class="crisis-logo">
                <img 
                    src="../pictures/ChatGPT Image Jan 16, 2026, 06_32_43 PM.png" 
                    alt="The Enterprise Logo"
                />
            </div>

            <div class="crisis-info">
                <h1 class="crisis-title">CRISIS</h1>
                <div class="crisis-stats">
                    <div class="budget" id="budget">$10,000.00</div>
                    <div class="timer" id="timer">0:00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Whispers in the Data Room Section -->
    <div class="dataroom-section">
        <div class="dataroom-header">
            <img 
                src="../pictures/ChatGPT Image Jan 16, 2026, 06_32_43 PM.png" 
                alt="The Enterprise Logo"
            />
            <h1 class="dataroom-title">WHISPERS IN THE DATA ROOM</h1>
        </div>

        <div class="dataroom-text" id="dataroom-text">
            text here
        </div>
    </div>

    <!-- Options Section -->
    <div class="options-section">
        <div class="options-content">
            <div class="options-logo">
                <img 
                    src="../pictures/ChatGPT Image Jan 16, 2026, 06_32_43 PM.png" 
                    alt="The Enterprise Logo"
                />
            </div>

            <div class="options-list">
                <button 
                    id="btn-option-a"
                    onclick="selectOption('optionA')"
                    class="option-button"
                >
                    <div id="option-a">OPTION A:</div>
                </button>

                <button 
                    id="btn-option-b"
                    onclick="selectOption('optionB')"
                    class="option-button"
                >
                    <div id="option-b">OPTION B:</div>
                </button>

                <button 
                    id="btn-option-c"
                    onclick="selectOption('optionC')"
                    class="option-button"
                >
                    <div id="option-c">OPTION C:</div>
                </button>

                <button 
                    id="btn-option-d"
                    onclick="selectOption('optionD')"
                    class="option-button"
                >
                    <div id="option-d">OPTION D:</div>
                </button>

                <button 
                    id="confirm-button"
                    onclick="confirmChoice()"
                    disabled
                    class="confirm-button"
                >
                    SELECT AN OPTION TO CONFIRM
                </button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Section -->
    <div class="leaderboard-section">
        <div class="leaderboard-header">
            <img 
                src="../pictures/ChatGPT Image Jan 16, 2026, 06_32_43 PM.png" 
                alt="The Enterprise Logo"
            />
            <h1 class="leaderboard-title">TEAM RANKINGS</h1>
        </div>

        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Team</th>
                    <th>Budget</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                <tr>
                    <td colspan="3" style="text-align: center;">Loading leaderboard...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-text">XIII</div>
    </div>

    <!-- JavaScript -->
    <script>
        const API_URL = 'http://localhost:3000';
        let selectedOption = null;
        let currentCrisisId = null;
        let userId = null;
        let timerInterval = null;
        let choiceConfirmed = false;
        let timeIsUp = false;

        // Open login page
        function openLoginPage() {
            window.location.href = 'login.html';
        }

        // Get user ID from URL parameters or sessionStorage
        async function getUserId() {
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('userId') || urlParams.get('username');
            
            if (userIdFromUrl) {
                const isObjectId = /^[a-f\d]{24}$/i.test(userIdFromUrl);
                
                if (isObjectId) {
                    sessionStorage.setItem('userId', userIdFromUrl);
                    return userIdFromUrl;
                } else {
                    try {
                        const response = await fetch(`${API_URL}/login-info`);
                        const users = await response.json();
                        
                        const user = users.find(u => u.username === userIdFromUrl);
                        if (user && user._id) {
                            sessionStorage.setItem('userId', user._id);
                            return user._id;
                        }
                    } catch (error) {
                        console.error('Error fetching user ID:', error);
                    }
                }
            }
            
            return sessionStorage.getItem('userId');
        }

        // Select an option
        function selectOption(option) {
            if (timeIsUp || choiceConfirmed) return;
            
            selectedOption = option;
            
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const selectedButton = document.getElementById(`btn-option-${option.slice(-1).toLowerCase()}`);
            selectedButton.classList.add('selected');
            
            const confirmButton = document.getElementById('confirm-button');
            confirmButton.disabled = false;
            confirmButton.textContent = 'CONFIRM CHOICE';
        }

        // Confirm choice
        async function confirmChoice() {
            if (!selectedOption || choiceConfirmed || timeIsUp) return;
            
            const confirmButton = document.getElementById('confirm-button');
            confirmButton.disabled = true;
            confirmButton.textContent = 'CHOICE CONFIRMED - WAITING FOR TIMER...';
            confirmButton.classList.add('animate-pulse');
            
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.disabled = true;
            });
            
            choiceConfirmed = true;
            waitForTimerToEnd();
        }

        // Wait for timer to end before applying choice
        function waitForTimerToEnd() {
            const checkInterval = setInterval(() => {
                if (timeIsUp) {
                    clearInterval(checkInterval);
                    
                    const confirmButton = document.getElementById('confirm-button');
                    confirmButton.textContent = 'TIMER ENDED - APPLYING CHOICE...';
                    
                    applyChoice();
                }
            }, 500);
        }

        // Apply the choice and update budget
        async function applyChoice() {
            if (!userId || !currentCrisisId || !selectedOption) {
                console.error('Missing required data to apply choice');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/apply-choice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        crisisId: currentCrisisId,
                        chosenOption: selectedOption
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const budgetElement = document.getElementById('budget');
                    budgetElement.classList.add('animate-pulse');
                    
                    const formattedBudget = '$' + result.data.newBudget.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    budgetElement.textContent = formattedBudget;
                    
                    setTimeout(() => {
                        budgetElement.classList.remove('animate-pulse');
                    }, 3000);
                    
                    const confirmButton = document.getElementById('confirm-button');
                    confirmButton.textContent = 'CHOICE APPLIED SUCCESSFULLY!';
                    confirmButton.classList.remove('animate-pulse');
                    confirmButton.classList.add('confirmed');
                    
                    setTimeout(() => {
                        fetchUserBudget();
                        fetchLeaderboard();
                    }, 3500);
                } else {
                    console.error('Failed to apply choice:', result.message);
                    const confirmButton = document.getElementById('confirm-button');
                    confirmButton.textContent = 'ERROR APPLYING CHOICE';
                    confirmButton.classList.add('error');
                }
            } catch (error) {
                console.error('Error applying choice:', error);
                const confirmButton = document.getElementById('confirm-button');
                confirmButton.textContent = 'ERROR: ' + error.message;
                confirmButton.classList.add('error');
            }
        }

        // Fetch and update timer from backend every second
        async function fetchAndUpdateTimer() {
            try {
                const response = await fetch(`${API_URL}/crisis/timer`);
                const result = await response.json();

                if (result.success && result.data) {
                    const timeRemaining = result.data.timeRemaining;
                    updateTimerDisplay(timeRemaining);
                }
            } catch (error) {
                console.error('Error fetching timer:', error);
            }
        }

        // Format and display timer
        function updateTimerDisplay(timeInSeconds) {
            const timerElement = document.getElementById('timer');
            
            if (timeInSeconds <= 0) {
                timeIsUp = true;
                timerElement.textContent = 'TIME\'S UP!';
                timerElement.classList.add('time-up');
                
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.disabled = true;
                });
                
                if (!choiceConfirmed) {
                    const confirmButton = document.getElementById('confirm-button');
                    confirmButton.disabled = true;
                    confirmButton.textContent = 'TIME\'S UP - NO MORE CHOICES';
                    confirmButton.classList.add('error');
                }
            } else {
                timeIsUp = false;
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;
                
                const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                timerElement.textContent = formattedTime;
                
                timerElement.classList.remove('time-up');
            }
        }

        // Start polling for timer updates every second
        function startTimerPolling() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            fetchAndUpdateTimer();
            timerInterval = setInterval(fetchAndUpdateTimer, 1000);
        }
  
        async function fetchLatestCrisis() {
            try {
                const response = await fetch(`${API_URL}/crisis/latest`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('No crisis available yet');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();

                if (result.success && result.data) {
                    const crisisData = result.data;
                    
                    if (!crisisData._id || !crisisData.crisis || !crisisData.options) {
                        console.error('Invalid crisis data structure:', crisisData);
                        return;
                    }
                    
                    const isNewCrisis = currentCrisisId !== null && currentCrisisId !== crisisData._id;
                    
                    if (isNewCrisis) {
                        console.log('ðŸ”¥ NEW CRISIS DETECTED! Resetting game state...');
                        
                        selectedOption = null;
                        choiceConfirmed = false;
                        timeIsUp = false;
                        
                        document.querySelectorAll('.option-button').forEach(btn => {
                            btn.disabled = false;
                            btn.classList.remove('selected');
                        });
                        
                        const confirmButton = document.getElementById('confirm-button');
                        if (confirmButton) {
                            confirmButton.disabled = true;
                            confirmButton.textContent = 'SELECT AN OPTION TO CONFIRM';
                            confirmButton.classList.remove('confirmed', 'error', 'animate-pulse');
                        }
                        
                        const timerElement = document.getElementById('timer');
                        if (timerElement) {
                            timerElement.classList.remove('time-up');
                        }
                    }
                    
                    currentCrisisId = crisisData._id;
                    
                    const dataroomText = document.getElementById('dataroom-text');
                    if (dataroomText) {
                        dataroomText.textContent = crisisData.crisis;
                    }
                    
                    const updateOption = (elementId, text) => {
                        const element = document.getElementById(elementId);
                        if (element && text) {
                            element.textContent = text;
                        }
                    };
                    
                    updateOption('option-a', crisisData.options.optionA?.text);
                    updateOption('option-b', crisisData.options.optionB?.text);
                    updateOption('option-c', crisisData.options.optionC?.text);
                    updateOption('option-d', crisisData.options.optionD?.text);
                }
            } catch (error) {
                console.error('Error fetching crisis:', error);
            }
        }

        // Fetch user budget
        async function fetchUserBudget() {
            if (!userId) return;
            
            try {
                const response = await fetch(`${API_URL}/user/${userId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    const formattedBudget = '$' + result.data.budget.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    document.getElementById('budget').textContent = formattedBudget;
                }
            } catch (error) {
                console.error('Error fetching user budget:', error);
            }
        }

        // Fetch and display leaderboard
        async function fetchLeaderboard() {
            try {
                const response = await fetch(`${API_URL}/login-info`);
                const users = await response.json();
                
                // Ensure we have an array to work with
                if (!Array.isArray(users)) {
                    throw new Error('Invalid response format');
                }
                
                // Sort users by budget in descending order
                const sortedUsers = users.sort((a, b) => (b.budget || 0) - (a.budget || 0));
                
                const leaderboardBody = document.getElementById('leaderboard-body');
                leaderboardBody.innerHTML = '';
                
                // Check if there are any users
                if (sortedUsers.length === 0) {
                    leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No teams available</td></tr>';
                    return;
                }
                
                // Loop through ALL users - no limit
                for (let index = 0; index < sortedUsers.length; index++) {
                    const user = sortedUsers[index];
                    const rank = index + 1;
                    const row = document.createElement('tr');
                    
                    // Add special styling for top 3
                    if (rank === 1) row.classList.add('rank-1');
                    else if (rank === 2) row.classList.add('rank-2');
                    else if (rank === 3) row.classList.add('rank-3');
                    
                    // Create rank badge
                    let rankBadge = '';
                    if (rank === 1) {
                        rankBadge = '<span class="rank-badge gold">ðŸ¥‡ 1st</span>';
                    } else if (rank === 2) {
                        rankBadge = '<span class="rank-badge silver">ðŸ¥ˆ 2nd</span>';
                    } else if (rank === 3) {
                        rankBadge = '<span class="rank-badge bronze">ðŸ¥‰ 3rd</span>';
                    } else {
                        rankBadge = `<span class="rank-badge">#${rank}</span>`;
                    }
                    
                    // Handle cases where budget might be undefined or null
                    const userBudget = user.budget !== undefined && user.budget !== null ? user.budget : 0;
                    
                    const formattedBudget = '

        // Initialize page
        window.addEventListener('DOMContentLoaded', async () => {
            userId = await getUserId();
            
            if (!userId) {
                console.warn('No user ID found. Budget updates may not work.');
            } else {
                console.log('User ID:', userId);
                fetchUserBudget();
            }
            
            startTimerPolling();
            fetchLeaderboard();
            
            setInterval(fetchLatestCrisis, 1000);
            setInterval(fetchLeaderboard, 5000); // Update leaderboard every 5 seconds
        });
    </script>
</body>
</html> + userBudget.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    // Use username or fallback to Team + rank
                    const teamName = user.username || user.name || `Team ${rank}`;
                    
                    row.innerHTML = `
                        <td>${rankBadge}</td>
                        <td>${teamName}</td>
                        <td>${formattedBudget}</td>
                    `;
                    
                    leaderboardBody.appendChild(row);
                }
                
                console.log(`Leaderboard updated with ${sortedUsers.length} teams`);
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                const leaderboardBody = document.getElementById('leaderboard-body');
                leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #ef4444;">Error loading leaderboard</td></tr>';
            }
        }

        // Initialize page
        window.addEventListener('DOMContentLoaded', async () => {
            userId = await getUserId();
            
            if (!userId) {
                console.warn('No user ID found. Budget updates may not work.');
            } else {
                console.log('User ID:', userId);
                fetchUserBudget();
            }
            
            startTimerPolling();
            fetchLeaderboard();
            
            setInterval(fetchLatestCrisis, 1000);
            setInterval(fetchLeaderboard, 5000); // Update leaderboard every 5 seconds
        });
    </script>
</body>
</html>